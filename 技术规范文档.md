# FoxAI 记账软件 - 技术规范文档

## 1. 系统架构设计

### 1.1 整体架构
```
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   前端界面层    │    │   业务逻辑层    │    │   数据存储层    │
│                 │    │                 │    │                 │
│ - React/Vue     │◄──►│ - Node.js       │◄──►│ - JSON/SQLite   │
│ - Responsive    │    │ - Express       │    │ - 本地文件      │
│ - PWA Support   │    │ - Business API  │    │ - 数据备份      │
└─────────────────┘    └─────────────────┘    └─────────────────┘
```

### 1.2 目录结构
```
foxai-accounting/
├── src/
│   ├── frontend/          # 前端代码
│   │   ├── components/    # React组件
│   │   ├── pages/         # 页面组件
│   │   ├── hooks/         # 自定义Hooks
│   │   ├── utils/         # 工具函数
│   │   └── styles/        # 样式文件
│   ├── backend/           # 后端代码
│   │   ├── routes/        # 路由定义
│   │   ├── controllers/   # 控制器
│   │   ├── models/        # 数据模型
│   │   ├── services/      # 业务服务
│   │   └── utils/         # 工具函数
│   └── shared/            # 共享代码
│       ├── types/         # TypeScript类型
│       └── constants/     # 常量定义
├── data/                  # 数据存储目录
├── assets/                # 静态资源
├── docs/                  # 文档
├── tests/                 # 测试文件
├── electron/              # Electron配置
└── package.json
```

## 1.3 Vercel部署可行性评估

### 1.3.1 当前架构与Vercel兼容性分析

#### ✅ 完全兼容的部分
- **前端技术栈**: React/Vue.js + TypeScript - Vercel原生支持
- **静态资源**: HTML/CSS/JS/图片等静态文件 - 完全支持
- **PWA功能**: Service Worker、Web App Manifest - Vercel支持
- **响应式设计**: 移动端适配 - 无限制

#### ⚠️ 需要调整的部分
- **后端架构**: 从Express服务器 → Vercel Serverless Functions
- **数据存储**: 从本地文件系统 → 云数据库服务
- **桌面应用**: Electron应用需要单独部署

#### ❌ 不兼容的部分
- **本地文件持久化**: Vercel文件系统为只读，无法写入数据
- **传统数据库**: 需要迁移到云数据库服务

### 1.3.2 免费部署方案设计

#### 方案一: Vercel + Vercel KV (推荐)
```
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   前端界面层    │    │ Serverless API  │    │   数据存储层    │
│                 │    │                 │    │                 │
│ - Next.js       │◄──►│ - Vercel        │◄──►│ - Vercel KV     │
│ - Responsive    │    │   Functions     │    │   (Redis)       │
│ - PWA Support   │    │ - API Routes    │    │ - 免费额度      │
└─────────────────┘    └─────────────────┘    └─────────────────┘
```

**免费额度**: 30,000 commands/month, 100KB storage
**适用场景**: 小型个人应用，数据量不大

#### 方案二: Vercel + PlanetScale
```
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   前端界面层    │    │ Serverless API  │    │   数据存储层    │
│                 │    │                 │    │                 │
│ - Next.js       │◄──►│ - Vercel        │◄──►│ - PlanetScale   │
│ - Responsive    │    │   Functions     │    │   (MySQL)       │
│ - PWA Support   │    │ - API Routes    │    │ - 免费额度      │
└─────────────────┘    └─────────────────┘    └─────────────────┘
```

**免费额度**: 1 database, 1GB storage, 1 billion row reads/month
**适用场景**: 需要关系型数据库的应用

#### 方案三: Vercel + Supabase
```
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   前端界面层    │    │ Serverless API  │    │   数据存储层    │
│                 │    │                 │    │                 │
│ - Next.js       │◄──►│ - Vercel        │◄──►│ - Supabase      │
│ - Responsive    │    │   Functions     │    │   (PostgreSQL)  │
│ - PWA Support   │    │ - API Routes    │    │ - 免费额度      │
└─────────────────┘    └─────────────────┘    └─────────────────┘
```

**免费额度**: 500MB database, 50MB file storage, 50,000 monthly active users
**适用场景**: 需要实时功能和文件存储的应用

## 2. 数据模型设计

### 2.1 核心数据结构

#### 交易记录 (Transaction)
```typescript
interface Transaction {
  id: string;                    // 唯一标识符
  date: string;                  // 交易日期 (YYYY-MM-DD)
  amount: number;                // 金额 (正数为盈利，负数为亏损)
  type: 'profit' | 'loss';       // 交易类型
  description?: string;          // 备注说明
  createdAt: string;            // 创建时间戳
  updatedAt: string;            // 更新时间戳
}
```

#### 用户设置 (Settings)
```typescript
interface Settings {
  currency: string;              // 货币单位 (默认: '¥')
  riskAlertEnabled: boolean;     // 风险提醒开关
  theme: 'light' | 'dark';       // 主题模式
  autoBackup: boolean;           // 自动备份开关
  dataRetentionDays: number;     // 数据保留天数
}
```

#### 风险状态 (RiskStatus)
```typescript
interface RiskStatus {
  isInRisk: boolean;             // 是否处于风险状态
  riskStartTime?: string;        // 风险开始时间
  consecutiveLosses: number;     // 连续亏损次数
  lastRiskDate?: string;         // 上次风险日期
}
```

### 2.2 数据存储方案

#### 文件存储结构
```
data/
├── transactions.json          # 交易记录
├── settings.json             # 用户设置
├── risk-status.json          # 风险状态
└── backups/                  # 备份文件夹
    ├── backup-2024-01-01.json
    └── backup-2024-01-02.json
```

#### 数据操作API
```typescript
// 数据访问层接口
interface DataService {
  // 交易记录操作
  getTransactions(dateRange?: DateRange): Promise<Transaction[]>;
  addTransaction(transaction: Omit<Transaction, 'id' | 'createdAt' | 'updatedAt'>): Promise<Transaction>;
  updateTransaction(id: string, updates: Partial<Transaction>): Promise<Transaction>;
  deleteTransaction(id: string): Promise<void>;
  
  // 设置操作
  getSettings(): Promise<Settings>;
  updateSettings(updates: Partial<Settings>): Promise<Settings>;
  
  // 风险状态操作
  getRiskStatus(): Promise<RiskStatus>;
  updateRiskStatus(status: RiskStatus): Promise<void>;
  
  // 数据备份
  createBackup(): Promise<string>;
  restoreBackup(backupDate: string): Promise<void>;
}
```

## 3. API 接口设计

### 3.1 RESTful API 规范

#### 交易记录接口
```typescript
// GET /api/transactions - 获取交易记录列表
// Query参数: page, limit, startDate, endDate, type
GET /api/transactions?startDate=2024-01-01&endDate=2024-01-31&type=profit

// POST /api/transactions - 创建新交易记录
POST /api/transactions
{
  "date": "2024-01-15",
  "amount": 150.50,
  "type": "profit",
  "description": "投资收益"
}

// PUT /api/transactions/:id - 更新交易记录
PUT /api/transactions/123e4567-e89b-12d3-a456-426614174000

// DELETE /api/transactions/:id - 删除交易记录
DELETE /api/transactions/123e4567-e89b-12d3-a456-426614174000
```

#### 统计分析接口
```typescript
// GET /api/statistics/daily - 日统计
GET /api/statistics/daily?date=2024-01-15

// GET /api/statistics/weekly - 周统计
GET /api/statistics/weekly?week=2024-W03

// GET /api/statistics/monthly - 月统计
GET /api/statistics/monthly?month=2024-01

// GET /api/statistics/trend - 趋势分析
GET /api/statistics/trend?period=30d
```

#### 风险管理接口
```typescript
// GET /api/risk/status - 获取风险状态
GET /api/risk/status

// POST /api/risk/check - 检查风险状态
POST /api/risk/check

// POST /api/risk/reset - 重置风险状态
POST /api/risk/reset
```

### 3.2 响应数据格式

#### 标准响应格式
```typescript
interface ApiResponse<T> {
  success: boolean;
  data?: T;
  message?: string;
  error?: {
    code: string;
    message: string;
    details?: any;
  };
  timestamp: string;
}
```

#### 统计数据响应格式
```typescript
interface StatisticsResponse {
  period: string;
  totalProfit: number;
  totalLoss: number;
  netProfit: number;
  transactionCount: number;
  profitTransactions: number;
  lossTransactions: number;
  averageProfit: number;
  averageLoss: number;
  profitRate: number; // 盈利率
}
```

## 4. 前端技术规范

### 4.1 组件设计原则
- 单一职责原则
- 可复用性设计
- Props接口类型化
- 状态管理规范化

### 4.2 核心组件设计

#### 数据录入组件
```typescript
interface TransactionFormProps {
  initialData?: Partial<Transaction>;
  onSubmit: (data: TransactionFormData) => void;
  onCancel?: () => void;
  loading?: boolean;
}

const TransactionForm: React.FC<TransactionFormProps> = ({ ... }) => {
  // 表单验证逻辑
  // 提交处理逻辑
  // UI渲染
};
```

#### 统计图表组件
```typescript
interface ChartProps {
  data: StatisticsData[];
  type: 'line' | 'bar' | 'pie';
  timeRange: TimeRange;
  onTimeRangeChange: (range: TimeRange) => void;
}
```

#### 风险提醒组件
```typescript
interface RiskAlertProps {
  riskStatus: RiskStatus;
  remainingTime: number; // 剩余时间(秒)
  onDismiss?: () => void;
}
```

### 4.3 状态管理
使用 React Context + useReducer 实现状态管理：

```typescript
// 全局状态类型
interface AppState {
  transactions: Transaction[];
  settings: Settings;
  riskStatus: RiskStatus;
  ui: {
    loading: boolean;
    currentPage: string;
    sidebarOpen: boolean;
  };
}

// Action类型
type AppAction = 
  | { type: 'SET_TRANSACTIONS'; payload: Transaction[] }
  | { type: 'ADD_TRANSACTION'; payload: Transaction }
  | { type: 'UPDATE_TRANSACTION'; payload: { id: string; updates: Partial<Transaction> } }
  | { type: 'DELETE_TRANSACTION'; payload: string }
  | { type: 'SET_SETTINGS'; payload: Settings }
  | { type: 'SET_RISK_STATUS'; payload: RiskStatus }
  | { type: 'SET_LOADING'; payload: boolean };
```

## 5. 性能优化策略

### 5.1 前端优化
- 组件懒加载 (React.lazy)
- 虚拟滚动 (大数据列表)
- 防抖节流 (输入框、按钮)
- 缓存策略 (localStorage)
- 图片优化 (WebP格式)

### 5.2 后端优化
- 数据分页查询
- 索引优化 (SQLite)
- 缓存机制 (内存缓存)
- 异步处理 (文件操作)

### 5.3 数据库优化
```sql
-- SQLite索引设计
CREATE INDEX idx_transactions_date ON transactions(date);
CREATE INDEX idx_transactions_type ON transactions(type);
CREATE INDEX idx_transactions_amount ON transactions(amount);
```

## 6. 安全性规范

### 6.1 数据安全
- 本地数据加密存储
- 敏感信息脱敏
- 定期数据备份
- 数据完整性校验

### 6.2 输入验证
```typescript
// 输入验证规则
const validationRules = {
  amount: {
    required: true,
    type: 'number',
    min: 0.01,
    max: 999999.99,
    precision: 2
  },
  date: {
    required: true,
    type: 'date',
    format: 'YYYY-MM-DD',
    maxDate: 'today'
  },
  description: {
    maxLength: 200,
    allowedChars: /^[\u4e00-\u9fa5a-zA-Z0-9\s,.!?]*$/
  }
};
```

## 7. 测试策略

### 7.1 单元测试
- 组件测试 (React Testing Library)
- 工具函数测试 (Jest)
- API接口测试
- 数据模型测试

### 7.2 集成测试
- 前后端集成测试
- 数据流测试
- 用户操作流程测试

### 7.3 端到端测试
- 关键业务流程
- 跨平台兼容性
- 性能基准测试

## 8. 部署配置

### 8.1 Electron 桌面端
```json
{
  "main": "dist/electron/main.js",
  "build": {
    "appId": "com.foxai.accounting",
    "productName": "FoxAI记账",
    "directories": {
      "output": "dist-electron"
    },
    "files": [
      "dist/**/*",
      "node_modules/**/*"
    ],
    "mac": {
      "category": "public.app-category.finance"
    },
    "win": {
      "target": "nsis"
    },
    "linux": {
      "target": "AppImage"
    }
  }
}
```

### 8.2 PWA 移动端
```json
{
  "name": "FoxAI记账",
  "short_name": "FoxAI记账",
  "description": "简洁易用的个人记账软件",
  "start_url": "/",
  "display": "standalone",
  "theme_color": "#FF6B35",
  "background_color": "#FFFFFF",
  "icons": [
    {
      "src": "/icons/icon-192.png",
      "sizes": "192x192",
      "type": "image/png"
    },
    {
      "src": "/icons/icon-512.png",
      "sizes": "512x512",
      "type": "image/png"
    }
  ]
}
```

## 9. 开发工具链

### 9.1 开发环境
- Node.js 18+
- TypeScript 5+
- React 18+
- Electron 25+
- Vite 4+ (构建工具)

### 9.2 代码质量工具
- ESLint (代码检查)
- Prettier (代码格式化)
- Husky (Git hooks)
- Lint-staged (暂存区检查)

### 9.3 开发脚本
```json
{
  "scripts": {
    "dev": "concurrently \"npm run dev:backend\" \"npm run dev:frontend\"",
    "dev:backend": "nodemon src/backend/server.ts",
    "dev:frontend": "vite serve",
    "build": "npm run build:backend && npm run build:frontend",
    "build:backend": "tsc && cp -r src/backend/public dist/backend/",
    "build:frontend": "vite build",
    "electron:dev": "electron .",
    "electron:build": "electron-builder",
    "test": "jest",
    "test:watch": "jest --watch",
    "lint": "eslint src --ext .ts,.tsx",
    "format": "prettier --write src/**/*.{ts,tsx,css,md}"
  }
}
```

## 10. Vercel免费部署实施指南

### 10.1 架构调整方案

#### 10.1.1 技术栈迁移
```typescript
// 从 Express 迁移到 Next.js API Routes
// 原 Express 路由
app.get('/api/transactions', getTransactionsHandler);

// 迁移到 Next.js API Routes
// pages/api/transactions/index.ts
export default async function handler(req: NextApiRequest, res: NextApiResponse) {
  if (req.method === 'GET') {
    // 处理获取交易记录逻辑
  }
}
```

#### 10.1.2 数据存储迁移
```typescript
// 从本地文件存储迁移到 Vercel KV
import { kv } from '@vercel/kv';

// 原本地文件操作
const fs = require('fs');
const data = fs.readFileSync('./data/transactions.json');

// 迁移到 Vercel KV
const transactions = await kv.get('transactions');

// 数据操作示例
export class VercelKVService implements DataService {
  async getTransactions(): Promise<Transaction[]> {
    const data = await kv.get('transactions');
    return data || [];
  }

  async addTransaction(transaction: Transaction): Promise<void> {
    const transactions = await this.getTransactions();
    transactions.push(transaction);
    await kv.set('transactions', transactions);
  }
}
```

### 10.2 推荐部署方案: Vercel + Vercel KV

#### 10.2.1 项目结构调整
```
foxai-accounting-vercel/
├── pages/                    # Next.js 页面
│   ├── index.tsx            # 首页
│   ├── statistics.tsx       # 统计页面
│   ├── settings.tsx         # 设置页面
│   └── api/                 # API 路由
│       ├── transactions.ts  # 交易记录API
│       ├── statistics.ts    # 统计API
│       └── risk.ts         # 风险管理API
├── components/              # React组件
├── lib/                     # 工具库
│   ├── kv.ts               # Vercel KV 客户端
│   └── utils.ts            # 工具函数
├── styles/                  # 样式文件
├── public/                  # 静态资源
├── vercel.json             # Vercel配置
└── package.json
```

#### 10.2.2 Vercel配置文件
```json
// vercel.json
{
  "functions": {
    "pages/api/**/*.ts": {
      "runtime": "nodejs18.x"
    }
  },
  "regions": ["sin1"],
  "env": {
    "KV_URL": "@kv-url",
    "KV_REST_API_URL": "@kv-rest-api-url",
    "KV_REST_API_TOKEN": "@kv-rest-api-token"
  }
}
```

#### 10.2.3 环境变量配置
```bash
# .env.local (本地开发)
KV_URL=redis://localhost:6379
KV_REST_API_URL=https://your-kv-url.vercel.app
KV_REST_API_TOKEN=your-kv-token

# Vercel 环境变量 (生产环境)
# 在 Vercel Dashboard 中配置
KV_URL=redis://your-redis-url
KV_REST_API_URL=https://your-kv-url.vercel.app
KV_REST_API_TOKEN=your-kv-token
```

#### 10.2.4 核心API实现
```typescript
// pages/api/transactions.ts
import { kv } from '@vercel/kv';
import type { NextApiRequest, NextApiResponse } from 'next';

export default async function handler(req: NextApiRequest, res: NextApiResponse) {
  try {
    switch (req.method) {
      case 'GET':
        const transactions = await kv.get('transactions') || [];
        res.status(200).json({ success: true, data: transactions });
        break;

      case 'POST':
        const newTransaction = req.body;
        newTransaction.id = Date.now().toString();
        newTransaction.createdAt = new Date().toISOString();

        const currentTransactions = await kv.get('transactions') || [];
        const updatedTransactions = [...currentTransactions, newTransaction];

        await kv.set('transactions', updatedTransactions);
        res.status(201).json({ success: true, data: newTransaction });
        break;

      default:
        res.setHeader('Allow', ['GET', 'POST']);
        res.status(405).end(`Method ${req.method} Not Allowed`);
    }
  } catch (error) {
    console.error('API Error:', error);
    res.status(500).json({ success: false, message: 'Internal Server Error' });
  }
}
```

#### 10.2.5 风险管理API
```typescript
// pages/api/risk.ts
import { kv } from '@vercel/kv';
import type { NextApiRequest, NextApiResponse } from 'next';

export default async function handler(req: NextApiRequest, res: NextApiResponse) {
  try {
    const riskStatus = await kv.get('riskStatus') || {
      isInRisk: false,
      consecutiveLosses: 0,
      lastRiskDate: null
    };

    // 检查是否需要重置风险状态 (24小时后)
    if (riskStatus.isInRisk && riskStatus.lastRiskDate) {
      const riskStartTime = new Date(riskStatus.lastRiskDate);
      const now = new Date();
      const hoursDiff = (now.getTime() - riskStartTime.getTime()) / (1000 * 60 * 60);

      if (hoursDiff >= 24) {
        riskStatus.isInRisk = false;
        riskStatus.consecutiveLosses = 0;
        await kv.set('riskStatus', riskStatus);
      }
    }

    res.status(200).json({ success: true, data: riskStatus });
  } catch (error) {
    console.error('Risk API Error:', error);
    res.status(500).json({ success: false, message: 'Internal Server Error' });
  }
}
```

### 10.3 部署步骤

#### 10.3.1 准备工作
1. **注册Vercel账户**: https://vercel.com
2. **安装Vercel CLI**: `npm i -g vercel`
3. **创建Vercel KV数据库**:
   ```bash
   # 安装 Vercel KV CLI
   npm i -g @vercel/kv

   # 创建 KV 数据库
   kv create foxai-accounting-db
   ```

#### 10.3.2 本地开发
```bash
# 安装依赖
npm install next react react-dom @vercel/kv

# 本地开发
npm run dev

# 本地测试 KV
vercel dev
```

#### 10.3.3 部署到Vercel
```bash
# 登录 Vercel
vercel login

# 部署项目
vercel

# 或者使用 Git 集成 (推荐)
# 推送代码到 GitHub/GitLab，Vercel 会自动部署
```

#### 10.3.4 环境变量配置
在 Vercel Dashboard 中配置以下环境变量：
- `KV_URL`: 从 KV 创建时获得
- `KV_REST_API_URL`: 从 KV 创建时获得
- `KV_REST_API_TOKEN`: 从 KV 创建时获得

### 10.4 免费额度监控

#### 10.4.1 Vercel 免费额度
- **每月免费额度**: 100GB 带宽，100GB 小时数
- **每月请求限制**: 100 次部署
- **自定义域名**: 不支持 (仅 *.vercel.app 子域名)

#### 10.4.2 Vercel KV 免费额度
- **每月命令数**: 30,000 次
- **存储容量**: 100KB
- **并发连接**: 10 个

#### 10.4.3 监控和优化
```typescript
// 简单的使用量监控
export class UsageMonitor {
  private static instance: UsageMonitor;
  private requestCount = 0;

  static getInstance(): UsageMonitor {
    if (!UsageMonitor.instance) {
      UsageMonitor.instance = new UsageMonitor();
    }
    return UsageMonitor.instance;
  }

  incrementRequest() {
    this.requestCount++;
    // 每月重置计数器 (简化版)
    if (this.requestCount > 25000) { // 接近免费额度上限
      console.warn('接近 Vercel KV 免费额度上限');
    }
  }
}
```

### 10.5 扩展方案

#### 10.5.1 付费升级选项
- **Vercel Pro**: $20/月，增加带宽和部署次数
- **Vercel KV 付费**: $0.25/GB/月，按使用量收费

#### 10.5.2 替代免费方案
- **Netlify**: 类似Vercel，支持免费部署
- **Railway**: 提供免费PostgreSQL数据库
- **Render**: 免费Web服务 + PostgreSQL

### 10.6 注意事项

#### 10.6.1 数据持久性
- Vercel KV 数据会持久保存，但需要注意免费额度
- 建议定期备份重要数据
- 考虑数据迁移方案以应对服务升级

#### 10.6.2 性能优化
- 使用 Next.js 的 ISR (Incremental Static Regeneration)
- 实现适当的缓存策略
- 优化图片和静态资源

#### 10.6.3 安全性
- 使用环境变量存储敏感信息
- 实现适当的输入验证
- 考虑添加用户认证 (未来版本)

---

此部署方案确保了 FoxAI 记账软件可以在完全免费的环境下运行，同时保持良好的性能和用户体验。